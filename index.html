<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¶–∏—Ñ—Ä–æ–≤–æ–π –î–≤–æ–π–Ω–∏–∫ –ó–µ–º–ª–∏ - –ú–∏–Ω–µ—Ä–∞–ª—å–Ω—ã–µ –†–µ—Å—É—Ä—Å—ã</title>

    <!-- Cesium CSS -->
    <link href="libs/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #cesiumContainer {
            width: 100vw;
            height: 100vh;
        }

        #toolbar {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(42, 42, 42, 0.9);
            padding: 15px;
            border-radius: 8px;
            color: white;
            max-width: 300px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        #toolbar h1 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #4FC3F7;
        }

        #toolbar p {
            font-size: 12px;
            margin-bottom: 15px;
            color: #B0BEC5;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            color: #CFD8DC;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #455A64;
            border-radius: 4px;
            background: #263238;
            color: white;
            font-size: 12px;
        }

        .control-group button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            background: #4FC3F7;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .control-group button:hover {
            background: #29B6F6;
        }

        #stats {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(42, 42, 42, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            color: white;
            font-size: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(42, 42, 42, 0.95);
            padding: 30px 50px;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            z-index: 2000;
            text-align: center;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #4FC3F7;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>

    <div id="toolbar">
        <h1>üåç –¶–∏—Ñ—Ä–æ–≤–æ–π –î–≤–æ–π–Ω–∏–∫ –ó–µ–º–ª–∏</h1>
        <p>–ú–∏–Ω–µ—Ä–∞–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –º–∏—Ä–∞ (USGS MRDS)</p>

        <div class="control-group">
            <label for="commodityFilter">–§–∏–ª—å—Ç—Ä –ø–æ —Ä–µ—Å—É—Ä—Å—É:</label>
            <select id="commodityFilter">
                <option value="">–í—Å–µ —Ä–µ—Å—É—Ä—Å—ã</option>
            </select>
        </div>

        <div class="control-group">
            <button id="loadDataBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>
    </div>

    <div id="stats">
        <div>–û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ —Ç–æ—á–µ–∫: <span id="pointCount">0</span></div>
        <div>–í—Å–µ–≥–æ –≤ –±–∞–∑–µ: <span id="totalCount">304,613</span></div>
    </div>

    <div id="loading" class="hidden">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>

    <!-- Cesium JS -->
    <script src="libs/Build/Cesium/Cesium.js"></script>

    <script>
        // Set Cesium base URL for Workers and Assets - must be set before Cesium initializes
        window.CESIUM_BASE_URL = 'libs/Build/Cesium/';

        // Wait for DOM and Cesium to be fully loaded before initializing
        function initializeCesium() {
        // Check if Cesium loaded successfully
        if (typeof Cesium === 'undefined') {
            document.body.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                            background: rgba(42, 42, 42, 0.95); padding: 40px; border-radius: 8px;
                            color: white; max-width: 600px; text-align: left; font-family: 'Segoe UI', sans-serif;">
                    <h2 style="color: #FF6B6B; margin-bottom: 20px;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Cesium</h2>
                    <p style="margin-bottom: 15px;">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Cesium –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å. –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –ø—Ä–∏—á–∏–Ω–∞–º:</p>
                    <ul style="margin-bottom: 20px; padding-left: 20px;">
                        <li style="margin-bottom: 10px;"><strong>–§–∞–π–ª –æ—Ç–∫—Ä—ã—Ç –Ω–∞–ø—Ä—è–º—É—é (file://)</strong> - Cesium —Ç—Ä–µ–±—É–µ—Ç –≤–µ–±-—Å–µ—Ä–≤–µ—Ä</li>
                        <li style="margin-bottom: 10px;"><strong>–§–∞–π–ª—ã Cesium –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –ø–∞–ø–∫–µ libs/</strong> - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞</li>
                        <li style="margin-bottom: 10px;"><strong>–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—É—Ç—è–º–∏ –∫ —Ñ–∞–π–ª–∞–º</strong> - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —Å–µ—Ä–≤–µ—Ä –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞</li>
                    </ul>
                    <div style="background: rgba(76, 175, 80, 0.2); border-left: 4px solid #4CAF50; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px; color: #4CAF50;">‚úÖ –†–µ—à–µ–Ω–∏–µ:</h3>
                        <p style="margin-bottom: 10px;">–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞:</p>
                        <code style="display: block; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 4px; font-family: monospace;">
                            python3 -m http.server 8000
                        </code>
                        <p style="margin-top: 10px;">–ó–∞—Ç–µ–º –æ—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: <strong style="color: #4FC3F7;">http://localhost:8000</strong></p>
                    </div>
                    <p style="font-size: 12px; color: #B0BEC5;">–ü–æ–¥—Ä–æ–±–Ω–µ–µ –≤ —Ñ–∞–π–ª–µ README.md</p>
                </div>
            `;
            throw new Error('Cesium library failed to load');
        }

        // Check if running from file:// protocol
        if (window.location.protocol === 'file:') {
            document.body.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                            background: rgba(42, 42, 42, 0.95); padding: 40px; border-radius: 8px;
                            color: white; max-width: 600px; text-align: left; font-family: 'Segoe UI', sans-serif;">
                    <h2 style="color: #FF6B6B; margin-bottom: 20px;">‚ö†Ô∏è –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª</h2>
                    <p style="margin-bottom: 15px;">–í—ã –æ—Ç–∫—Ä—ã–ª–∏ —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª <code style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 3px;">file://</code></p>
                    <p style="margin-bottom: 20px;">Cesium —Ç—Ä–µ–±—É–µ—Ç –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (CORS –∏ Web Workers).</p>
                    <div style="background: rgba(76, 175, 80, 0.2); border-left: 4px solid #4CAF50; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px; color: #4CAF50;">‚úÖ –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ:</h3>
                        <p style="margin-bottom: 10px;"><strong>1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–µ—Ä–º–∏–Ω–∞–ª –≤ –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞</strong></p>
                        <p style="margin-bottom: 10px;"><strong>2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä:</strong></p>
                        <code style="display: block; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 4px; font-family: monospace; margin-bottom: 15px;">
                            python3 -m http.server 8000
                        </code>
                        <p style="margin-bottom: 5px;"><strong>3. –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:</strong></p>
                        <a href="http://localhost:8000" style="display: block; background: #4FC3F7; color: white; padding: 12px; text-align: center; border-radius: 4px; text-decoration: none; font-weight: bold; margin-bottom: 10px;">
                            http://localhost:8000
                        </a>
                        <p style="font-size: 11px; color: #90A4AE; margin-top: 10px;">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (Node.js): <code style="background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 2px;">npx http-server</code></p>
                    </div>
                    <p style="font-size: 12px; color: #B0BEC5; margin-bottom: 15px;">–ü–æ–¥—Ä–æ–±–Ω–µ–µ –≤ —Ñ–∞–π–ª–µ README.md</p>
                    <div style="background: rgba(255,152,0,0.1); border-left: 4px solid #FF9800; padding: 10px; border-radius: 4px;">
                        <p style="font-size: 11px; color: #FFB74D; margin: 0;"><strong>–¢–µ–∫—É—â–∏–π URL:</strong> ${window.location.href}</p>
                    </div>
                </div>
            `;
            throw new Error('Application must be served via HTTP/HTTPS protocol, not file://');
        }

        // Disable Cesium Ion (using free OpenStreetMap instead)
        Cesium.Ion.defaultAccessToken = undefined;

        // Initialize the Cesium Viewer with OpenStreetMap imagery (no token required)
        let viewer;
        try {
            viewer = new Cesium.Viewer('cesiumContainer', {
                baseLayerPicker: false,  // Disable base layer picker to avoid Ion dependency
                geocoder: true,
                homeButton: true,
                sceneModePicker: true,
                navigationHelpButton: true,
                animation: false,
                timeline: false,
                fullscreenButton: true,
                vrButton: false,
                imageryProvider: new Cesium.OpenStreetMapImageryProvider({
                    url: 'https://tile.openstreetmap.org/'
                }),
                terrainProvider: new Cesium.EllipsoidTerrainProvider()  // Use simple ellipsoid terrain
            });
        } catch (error) {
            console.error('Failed to initialize Cesium Viewer:', error);
            document.body.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                            background: rgba(42, 42, 42, 0.95); padding: 40px; border-radius: 8px;
                            color: white; max-width: 600px; text-align: left; font-family: 'Segoe UI', sans-serif;">
                    <h2 style="color: #FF6B6B; margin-bottom: 20px;">‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ 3D-–≥–ª–æ–±—É—Å–∞</h2>
                    <p style="margin-bottom: 15px;">–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å 3D-—Å—Ü–µ–Ω—É Cesium.</p>
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 4px; margin-bottom: 20px; font-family: monospace; font-size: 12px; overflow-x: auto;">
                        ${error.message}
                    </div>
                    <p style="margin-bottom: 10px;"><strong>–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</strong></p>
                    <ul style="margin-bottom: 20px; padding-left: 20px; font-size: 14px;">
                        <li style="margin-bottom: 8px;">–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebGL</li>
                        <li style="margin-bottom: 8px;">–§–∞–π–ª –æ—Ç–∫—Ä—ã—Ç —á–µ—Ä–µ–∑ file:// –≤–º–µ—Å—Ç–æ http://</li>
                        <li style="margin-bottom: 8px;">–£—Å—Ç–∞—Ä–µ–≤—à–∞—è –≤–µ—Ä—Å–∏—è –±—Ä–∞—É–∑–µ—Ä–∞</li>
                    </ul>
                    <div style="background: rgba(76, 175, 80, 0.2); border-left: 4px solid #4CAF50; padding: 15px; border-radius: 4px;">
                        <p style="margin-bottom: 10px;"><strong>–ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä:</strong></p>
                        <code style="display: block; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 4px;">
                            python3 -m http.server 8000
                        </code>
                        <p style="margin-top: 10px;">–û—Ç–∫—Ä–æ–π—Ç–µ: <strong style="color: #4FC3F7;">http://localhost:8000</strong></p>
                    </div>
                </div>
            `;
            throw error;
        }

        // Set initial camera position to show the whole Earth
        viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(0, 30, 20000000),
            orientation: {
                heading: 0.0,
                pitch: -Cesium.Math.PI_OVER_TWO,
                roll: 0.0
            }
        });

        // Global variables
        let allData = null;
        let currentDataSource = null;
        let commodities = new Set();

        // Color mapping for different commodities
        const commodityColors = {
            'Gold': Cesium.Color.GOLD,
            'Silver': Cesium.Color.SILVER,
            'Copper': Cesium.Color.CHOCOLATE,
            'Iron': Cesium.Color.DARKRED,
            'Uranium': Cesium.Color.LIME,
            'Coal': Cesium.Color.BLACK,
            'Chromium': Cesium.Color.DARKGRAY,
            'Tungsten': Cesium.Color.GRAY,
            'Manganese': Cesium.Color.PURPLE,
            'Mercury': Cesium.Color.LIGHTGRAY,
            'Tin': Cesium.Color.LIGHTSTEELBLUE,
            'Lead': Cesium.Color.DARKSLATEGRAY
        };

        // Function to get color for commodity
        function getColorForCommodity(commodity) {
            if (commodityColors[commodity]) {
                return commodityColors[commodity];
            }
            return Cesium.Color.CYAN;
        }

        // Load GeoJSON data
        async function loadData() {
            const loadingDiv = document.getElementById('loading');
            const loadBtn = document.getElementById('loadDataBtn');

            loadingDiv.classList.remove('hidden');
            loadBtn.disabled = true;

            try {
                const response = await fetch('data/mrds.geojson');

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('–§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–∞—á–∞–π—Ç–µ –∏ —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–≥–ª–∞—Å–Ω–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ data/README.md');
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const geojson = await response.json();

                if (!geojson.features || geojson.features.length === 0) {
                    throw new Error('–§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç');
                }

                allData = geojson;

                // Extract unique commodities
                geojson.features.forEach(feature => {
                    const commodity = feature.properties.commodity;
                    if (commodity) {
                        commodities.add(commodity);
                    }
                });

                // Populate commodity filter
                const select = document.getElementById('commodityFilter');
                const sortedCommodities = Array.from(commodities).sort();
                sortedCommodities.forEach(commodity => {
                    const option = document.createElement('option');
                    option.value = commodity;
                    option.textContent = commodity;
                    select.appendChild(option);
                });

                // Display all data initially
                displayData(geojson);

                loadingDiv.classList.add('hidden');
                loadBtn.textContent = '–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã';

            } catch (error) {
                console.error('Error loading data:', error);
                loadingDiv.innerHTML = `
                    <div style="color: #FF6B6B; max-width: 400px;">
                        <h3 style="margin-bottom: 10px;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h3>
                        <p style="margin-bottom: 15px;">${error.message}</p>
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; text-align: left; font-size: 11px;">
                            <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö:</strong><br><br>
                            1. –°–∫–∞—á–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ:<br>
                            <code style="background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 2px;">curl -L -o data/mrds-csv.zip https://mrdata.usgs.gov/mrds/mrds-csv.zip</code><br><br>
                            2. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –∞—Ä—Ö–∏–≤:<br>
                            <code style="background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 2px;">unzip data/mrds-csv.zip -d data/</code><br><br>
                            3. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ GeoJSON:<br>
                            <code style="background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 2px;">python3 data/convert_to_geojson.py</code><br><br>
                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ: <a href="data/README.md" style="color: #4FC3F7;">data/README.md</a>
                        </div>
                    </div>
                `;
                loadBtn.disabled = false;
                loadBtn.textContent = '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É';
            }
        }

        // Display data on globe
        function displayData(geojson) {
            // Remove previous data source if exists
            if (currentDataSource) {
                viewer.dataSources.remove(currentDataSource);
            }

            // Create new data source
            currentDataSource = new Cesium.CustomDataSource('mrds');

            let displayedCount = 0;

            // Add points to the globe
            geojson.features.forEach(feature => {
                const coords = feature.properties;
                const lon = feature.geometry.coordinates[0];
                const lat = feature.geometry.coordinates[1];
                const commodity = coords.commodity || 'Unknown';

                const entity = currentDataSource.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(lon, lat),
                    point: {
                        pixelSize: 5,
                        color: getColorForCommodity(commodity),
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 1
                    },
                    description: `
                        <h3>${coords.name}</h3>
                        <p><strong>–†–µ—Å—É—Ä—Å:</strong> ${commodity}</p>
                        ${coords.commodity2 ? `<p><strong>–î–æ–ø. —Ä–µ—Å—É—Ä—Å:</strong> ${coords.commodity2}</p>` : ''}
                        ${coords.commodity3 ? `<p><strong>–î–æ–ø. —Ä–µ—Å—É—Ä—Å:</strong> ${coords.commodity3}</p>` : ''}
                        <p><strong>–°—Ç—Ä–∞–Ω–∞:</strong> ${coords.country}</p>
                        ${coords.state ? `<p><strong>–®—Ç–∞—Ç/–†–µ–≥–∏–æ–Ω:</strong> ${coords.state}</p>` : ''}
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${coords.dev_status}</p>
                        ${coords.url ? `<p><a href="${coords.url}" target="_blank">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a></p>` : ''}
                    `
                });

                displayedCount++;
            });

            viewer.dataSources.add(currentDataSource);

            // Update stats
            document.getElementById('pointCount').textContent = displayedCount.toLocaleString('ru-RU');
        }

        // Filter data by commodity
        document.getElementById('commodityFilter').addEventListener('change', function(e) {
            const selectedCommodity = e.target.value;

            if (!allData) return;

            if (selectedCommodity === '') {
                displayData(allData);
            } else {
                const filtered = {
                    type: 'FeatureCollection',
                    features: allData.features.filter(f =>
                        f.properties.commodity === selectedCommodity ||
                        f.properties.commodity2 === selectedCommodity ||
                        f.properties.commodity3 === selectedCommodity
                    )
                };
                displayData(filtered);
            }
        });

        // Load data button
        document.getElementById('loadDataBtn').addEventListener('click', loadData);

        // Auto-load data on page load (optional - remove if you want manual loading)
        window.addEventListener('load', () => {
            // Uncomment to auto-load:
            // loadData();
        });
        } // End of initializeCesium function

        // Initialize Cesium when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeCesium);
        } else {
            // DOM is already loaded, initialize immediately
            initializeCesium();
        }
    </script>
</body>
</html>
