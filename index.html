<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¶–∏—Ñ—Ä–æ–≤–æ–π –î–≤–æ–π–Ω–∏–∫ –ó–µ–º–ª–∏ - –ú–∏–Ω–µ—Ä–∞–ª—å–Ω—ã–µ –†–µ—Å—É—Ä—Å—ã</title>

    <!-- Cesium CSS -->
    <link href="libs/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #cesiumContainer {
            width: 100vw;
            height: 100vh;
        }

        #toolbar {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(42, 42, 42, 0.9);
            padding: 15px;
            border-radius: 8px;
            color: white;
            max-width: 300px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        #toolbar h1 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #4FC3F7;
        }

        #toolbar p {
            font-size: 12px;
            margin-bottom: 15px;
            color: #B0BEC5;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            color: #CFD8DC;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #455A64;
            border-radius: 4px;
            background: #263238;
            color: white;
            font-size: 12px;
        }

        .control-group button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 4px;
            background: #4FC3F7;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .control-group button:hover {
            background: #29B6F6;
        }

        #stats {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(42, 42, 42, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            color: white;
            font-size: 12px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(42, 42, 42, 0.95);
            padding: 30px 50px;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            z-index: 2000;
            text-align: center;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #4FC3F7;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>

    <div id="toolbar">
        <h1>üåç –¶–∏—Ñ—Ä–æ–≤–æ–π –î–≤–æ–π–Ω–∏–∫ –ó–µ–º–ª–∏</h1>
        <p>–ú–∏–Ω–µ—Ä–∞–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –º–∏—Ä–∞ (USGS MRDS)</p>

        <div class="control-group">
            <label for="commodityFilter">–§–∏–ª—å—Ç—Ä –ø–æ —Ä–µ—Å—É—Ä—Å—É:</label>
            <select id="commodityFilter">
                <option value="">–í—Å–µ —Ä–µ—Å—É—Ä—Å—ã</option>
            </select>
        </div>

        <div class="control-group">
            <button id="loadDataBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>
    </div>

    <div id="stats">
        <div>–û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ —Ç–æ—á–µ–∫: <span id="pointCount">0</span></div>
        <div>–í—Å–µ–≥–æ –≤ –±–∞–∑–µ: <span id="totalCount">304,613</span></div>
    </div>

    <div id="loading" class="hidden">
        <div class="spinner"></div>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>

    <!-- Cesium JS -->
    <script src="libs/Build/Cesium/Cesium.js"></script>

    <script>
        // Set Cesium base URL for Workers and Assets - must be set before Cesium initializes
        window.CESIUM_BASE_URL = 'libs/Build/Cesium/';

        // Wait for DOM and Cesium to be fully loaded before initializing
        function initializeCesium() {
        // Check if Cesium loaded successfully
        if (typeof Cesium === 'undefined') {
            document.body.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                            background: rgba(42, 42, 42, 0.95); padding: 40px; border-radius: 8px;
                            color: white; max-width: 600px; text-align: left; font-family: 'Segoe UI', sans-serif;">
                    <h2 style="color: #FF6B6B; margin-bottom: 20px;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Cesium</h2>
                    <p style="margin-bottom: 15px;">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Cesium –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å. –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –ø—Ä–∏—á–∏–Ω–∞–º:</p>
                    <ul style="margin-bottom: 20px; padding-left: 20px;">
                        <li style="margin-bottom: 10px;"><strong>–§–∞–π–ª –æ—Ç–∫—Ä—ã—Ç –Ω–∞–ø—Ä—è–º—É—é (file://)</strong> - Cesium —Ç—Ä–µ–±—É–µ—Ç –≤–µ–±-—Å–µ—Ä–≤–µ—Ä</li>
                        <li style="margin-bottom: 10px;"><strong>–§–∞–π–ª—ã Cesium –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –ø–∞–ø–∫–µ libs/</strong> - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞</li>
                        <li style="margin-bottom: 10px;"><strong>–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—É—Ç—è–º–∏ –∫ —Ñ–∞–π–ª–∞–º</strong> - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —Å–µ—Ä–≤–µ—Ä –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞</li>
                    </ul>
                    <div style="background: rgba(76, 175, 80, 0.2); border-left: 4px solid #4CAF50; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 10px; color: #4CAF50;">‚úÖ –†–µ—à–µ–Ω–∏–µ:</h3>
                        <p style="margin-bottom: 10px;">–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞:</p>
                        <code style="display: block; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 4px; font-family: monospace;">
                            python3 -m http.server 8000
                        </code>
                        <p style="margin-top: 10px;">–ó–∞—Ç–µ–º –æ—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: <strong style="color: #4FC3F7;">http://localhost:8000</strong></p>
                    </div>
                    <p style="font-size: 12px; color: #B0BEC5;">–ü–æ–¥—Ä–æ–±–Ω–µ–µ –≤ —Ñ–∞–π–ª–µ README.md</p>
                </div>
            `;
            throw new Error('Cesium library failed to load');
        }

        // Check if running from file:// protocol
        if (window.location.protocol === 'file:') {
            document.body.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                            background: rgba(42, 42, 42, 0.95); padding: 40px; border-radius: 8px;
                            color: white; max-width: 600px; text-align: left; font-family: 'Segoe UI', sans-serif;">
                    <h2 style="color: #FF6B6B; margin-bottom: 20px;">‚ö†Ô∏è –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª</h2>
                    <p style="margin-bottom: 15px;">–í—ã –æ—Ç–∫—Ä—ã–ª–∏ —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª <code style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 3px;">file://</code></p>
                    <p style="margin-bottom: 20px;">Cesium —Ç—Ä–µ–±—É–µ—Ç –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (CORS –∏ Web Workers).</p>
                    <div style="background: rgba(76, 175, 80, 0.2); border-left: 4px solid #4CAF50; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px; color: #4CAF50;">‚úÖ –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ:</h3>
                        <p style="margin-bottom: 10px;"><strong>1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–µ—Ä–º–∏–Ω–∞–ª –≤ –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞</strong></p>
                        <p style="margin-bottom: 10px;"><strong>2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä:</strong></p>
                        <code style="display: block; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 4px; font-family: monospace; margin-bottom: 15px;">
                            python3 -m http.server 8000
                        </code>
                        <p style="margin-bottom: 5px;"><strong>3. –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:</strong></p>
                        <a href="http://localhost:8000" style="display: block; background: #4FC3F7; color: white; padding: 12px; text-align: center; border-radius: 4px; text-decoration: none; font-weight: bold; margin-bottom: 10px;">
                            http://localhost:8000
                        </a>
                        <p style="font-size: 11px; color: #90A4AE; margin-top: 10px;">–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (Node.js): <code style="background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 2px;">npx http-server</code></p>
                    </div>
                    <p style="font-size: 12px; color: #B0BEC5; margin-bottom: 15px;">–ü–æ–¥—Ä–æ–±–Ω–µ–µ –≤ —Ñ–∞–π–ª–µ README.md</p>
                    <div style="background: rgba(255,152,0,0.1); border-left: 4px solid #FF9800; padding: 10px; border-radius: 4px;">
                        <p style="font-size: 11px; color: #FFB74D; margin: 0;"><strong>–¢–µ–∫—É—â–∏–π URL:</strong> ${window.location.href}</p>
                    </div>
                </div>
            `;
            throw new Error('Application must be served via HTTP/HTTPS protocol, not file://');
        }

        // Disable Cesium Ion (using free OpenStreetMap instead)
        Cesium.Ion.defaultAccessToken = undefined;

        // Initialize the Cesium Viewer with fallback imagery options
        let viewer;
        try {
            // List of free tile providers to try (in order of preference)
            // Includes multiple regions and types for better global coverage
            const tileProviders = [
                {
                    name: 'ESRI World Street Map',
                    type: 'arcgis',
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer'
                },
                {
                    name: 'ESRI World Imagery',
                    type: 'arcgis',
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer'
                },
                {
                    name: 'Carto Voyager',
                    type: 'xyz',
                    url: 'https://basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png'
                },
                {
                    name: 'Carto Light',
                    type: 'xyz',
                    url: 'https://basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}.png'
                },
                {
                    name: 'OpenStreetMap (Standard)',
                    type: 'osm',
                    url: 'https://tile.openstreetmap.org/'
                },
                {
                    name: 'OpenStreetMap DE',
                    type: 'osm',
                    url: 'https://tile.openstreetmap.de/'
                },
                {
                    name: 'Natural Earth (Built-in)',
                    type: 'natural_earth',
                    url: null  // Uses built-in Cesium textures
                }
            ];

            // Create viewer without imagery first, then add layers
            viewer = new Cesium.Viewer('cesiumContainer', {
                baseLayerPicker: false,  // Disable base layer picker to avoid Ion dependency
                geocoder: false,  // Disable geocoder (requires Ion)
                homeButton: true,
                sceneModePicker: true,
                navigationHelpButton: true,
                animation: false,
                timeline: false,
                fullscreenButton: true,
                vrButton: false,
                imageryProvider: false,  // Don't add default imagery - we'll add our own
                terrainProvider: new Cesium.EllipsoidTerrainProvider()  // Use simple ellipsoid terrain
            });

            // Show a simple land/ocean coloring using the globe's base color
            viewer.scene.globe.baseColor = Cesium.Color.fromCssColorString('#1a3a52');

            // Enable lighting for better visual appearance
            viewer.scene.globe.enableLighting = false;  // Disable lighting to avoid shadows on blue globe

            // Set globe color to show land/ocean differentiation
            viewer.scene.globe.showGroundAtmosphere = true;

            // Track tile loading status
            let tilesLoadedCount = 0;
            let tilesFailedCount = 0;
            let currentProviderIndex = 0;
            let providerSwitchInProgress = false;

            // Function to create imagery provider based on type (async for some providers)
            async function createImageryProvider(provider) {
                switch (provider.type) {
                    case 'arcgis':
                        // ArcGisMapServerImageryProvider uses async factory in Cesium 1.104+
                        return await Cesium.ArcGisMapServerImageryProvider.fromUrl(provider.url);
                    case 'xyz':
                        return new Cesium.UrlTemplateImageryProvider({
                            url: provider.url,
                            credit: 'Map tiles by Carto'
                        });
                    case 'osm':
                        return new Cesium.OpenStreetMapImageryProvider({
                            url: provider.url
                        });
                    case 'natural_earth':
                        // TileMapServiceImageryProvider uses async factory in Cesium 1.104+
                        return await Cesium.TileMapServiceImageryProvider.fromUrl(
                            Cesium.buildModuleUrl('Assets/Textures/NaturalEarthII')
                        );
                    default:
                        return new Cesium.OpenStreetMapImageryProvider({
                            url: provider.url
                        });
                }
            }

            // Function to add imagery layer with error handling (async)
            async function addImageryLayer(providerIndex) {
                if (providerIndex >= tileProviders.length) {
                    console.error('All tile providers failed. Globe will display without map tiles.');
                    console.warn('You may need to check your internet connection or firewall settings.');
                    return;
                }

                const provider = tileProviders[providerIndex];
                console.log(`Trying tile provider: ${provider.name}`);

                try {
                    const imageryProvider = await createImageryProvider(provider);
                    const layer = viewer.scene.globe.imageryLayers.addImageryProvider(imageryProvider);

                    // Natural Earth is built-in and always works
                    if (provider.type === 'natural_earth') {
                        console.log(`Using built-in ${provider.name} - this is the fallback option`);
                        return;
                    }

                    // Set up error handling for this layer
                    let errorCount = 0;
                    const maxErrors = 3;  // Switch provider after 3 consecutive errors (faster switching)

                    imageryProvider.errorEvent.addEventListener(function(error) {
                        errorCount++;
                        tilesFailedCount++;

                        if (errorCount <= 2) {
                            console.warn(`Tile load error from ${provider.name}:`, error.message || error);
                        }

                        // If too many errors, try next provider
                        if (errorCount >= maxErrors && !providerSwitchInProgress) {
                            providerSwitchInProgress = true;
                            console.warn(`Too many errors from ${provider.name}, trying next provider...`);

                            // Remove the failing layer
                            viewer.scene.globe.imageryLayers.remove(layer);

                            // Reset counters and try next provider
                            tilesLoadedCount = 0;
                            tilesFailedCount = 0;
                            currentProviderIndex++;

                            setTimeout(function() {
                                providerSwitchInProgress = false;
                                addImageryLayer(currentProviderIndex);
                            }, 300);
                        }
                    });

                    // Track successful loads by monitoring tile progress
                    let hadSuccessfulLoad = false;
                    let progressListener = function(queuedTileCount) {
                        if (!hadSuccessfulLoad && queuedTileCount > 0) {
                            // Tiles are being queued, provider is working
                            hadSuccessfulLoad = true;
                            tilesLoadedCount++;
                            console.log(`‚úì Map tiles loading successfully from ${provider.name}`);
                        }
                    };
                    viewer.scene.globe.tileLoadProgressEvent.addEventListener(progressListener);

                    // Check if tiles are loading after a delay (reduced from 5s to 3s)
                    setTimeout(function() {
                        if (!hadSuccessfulLoad && tilesFailedCount === 0 && !providerSwitchInProgress) {
                            console.warn(`No tile activity from ${provider.name}, trying next provider...`);
                            providerSwitchInProgress = true;
                            viewer.scene.globe.imageryLayers.remove(layer);
                            viewer.scene.globe.tileLoadProgressEvent.removeEventListener(progressListener);
                            currentProviderIndex++;
                            setTimeout(function() {
                                providerSwitchInProgress = false;
                                addImageryLayer(currentProviderIndex);
                            }, 300);
                        }
                    }, 3000);

                } catch (e) {
                    console.warn(`Failed to create provider ${provider.name}:`, e);
                    addImageryLayer(providerIndex + 1);
                }
            }

            // Start with first provider
            addImageryLayer(0);

        } catch (error) {
            console.error('Failed to initialize Cesium Viewer:', error);
            document.body.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                            background: rgba(42, 42, 42, 0.95); padding: 40px; border-radius: 8px;
                            color: white; max-width: 600px; text-align: left; font-family: 'Segoe UI', sans-serif;">
                    <h2 style="color: #FF6B6B; margin-bottom: 20px;">‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ 3D-–≥–ª–æ–±—É—Å–∞</h2>
                    <p style="margin-bottom: 15px;">–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å 3D-—Å—Ü–µ–Ω—É Cesium.</p>
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 4px; margin-bottom: 20px; font-family: monospace; font-size: 12px; overflow-x: auto;">
                        ${error.message}
                    </div>
                    <p style="margin-bottom: 10px;"><strong>–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</strong></p>
                    <ul style="margin-bottom: 20px; padding-left: 20px; font-size: 14px;">
                        <li style="margin-bottom: 8px;">–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç WebGL</li>
                        <li style="margin-bottom: 8px;">–§–∞–π–ª –æ—Ç–∫—Ä—ã—Ç —á–µ—Ä–µ–∑ file:// –≤–º–µ—Å—Ç–æ http://</li>
                        <li style="margin-bottom: 8px;">–£—Å—Ç–∞—Ä–µ–≤—à–∞—è –≤–µ—Ä—Å–∏—è –±—Ä–∞—É–∑–µ—Ä–∞</li>
                    </ul>
                    <div style="background: rgba(76, 175, 80, 0.2); border-left: 4px solid #4CAF50; padding: 15px; border-radius: 4px;">
                        <p style="margin-bottom: 10px;"><strong>–ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä:</strong></p>
                        <code style="display: block; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 4px;">
                            python3 -m http.server 8000
                        </code>
                        <p style="margin-top: 10px;">–û—Ç–∫—Ä–æ–π—Ç–µ: <strong style="color: #4FC3F7;">http://localhost:8000</strong></p>
                    </div>
                </div>
            `;
            throw error;
        }

        // Set initial camera position to show the whole Earth
        viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(0, 30, 20000000),
            orientation: {
                heading: 0.0,
                pitch: -Cesium.Math.PI_OVER_TWO,
                roll: 0.0
            }
        });

        // Global variables
        let allData = null;
        let currentDataSource = null;
        let commodities = new Set();
        let clickHandler = null;  // Global click handler to avoid creating multiple handlers

        // Russian translations for commodity names
        const commodityTranslations = {
            'Gold': '–ó–æ–ª–æ—Ç–æ',
            'Silver': '–°–µ—Ä–µ–±—Ä–æ',
            'Copper': '–ú–µ–¥—å',
            'Iron': '–ñ–µ–ª–µ–∑–æ',
            'Uranium': '–£—Ä–∞–Ω',
            'Coal': '–£–≥–æ–ª—å',
            'Chromium': '–•—Ä–æ–º',
            'Tungsten': '–í–æ–ª—å—Ñ—Ä–∞–º',
            'Manganese': '–ú–∞—Ä–≥–∞–Ω–µ—Ü',
            'Mercury': '–†—Ç—É—Ç—å',
            'Tin': '–û–ª–æ–≤–æ',
            'Lead': '–°–≤–∏–Ω–µ—Ü',
            'Zinc': '–¶–∏–Ω–∫',
            'Nickel': '–ù–∏–∫–µ–ª—å',
            'Platinum': '–ü–ª–∞—Ç–∏–Ω–∞',
            'Aluminum': '–ê–ª—é–º–∏–Ω–∏–π',
            'Bauxite': '–ë–æ–∫—Å–∏—Ç',
            'Diamond': '–ê–ª–º–∞–∑',
            'Emerald': '–ò–∑—É–º—Ä—É–¥',
            'Ruby': '–†—É–±–∏–Ω',
            'Sapphire': '–°–∞–ø—Ñ–∏—Ä',
            'Lithium': '–õ–∏—Ç–∏–π',
            'Cobalt': '–ö–æ–±–∞–ª—å—Ç',
            'Titanium': '–¢–∏—Ç–∞–Ω',
            'Vanadium': '–í–∞–Ω–∞–¥–∏–π',
            'Molybdenum': '–ú–æ–ª–∏–±–¥–µ–Ω',
            'Phosphate': '–§–æ—Å—Ñ–∞—Ç',
            'Potash': '–ü–æ—Ç–∞—à',
            'Salt': '–°–æ–ª—å',
            'Sulfur': '–°–µ—Ä–∞',
            'Graphite': '–ì—Ä–∞—Ñ–∏—Ç',
            'Talc': '–¢–∞–ª—å–∫',
            'Gypsum': '–ì–∏–ø—Å',
            'Limestone': '–ò–∑–≤–µ—Å—Ç–Ω—è–∫',
            'Marble': '–ú—Ä–∞–º–æ—Ä',
            'Granite': '–ì—Ä–∞–Ω–∏—Ç',
            'Sand': '–ü–µ—Å–æ–∫',
            'Gravel': '–ì—Ä–∞–≤–∏–π',
            'Clay': '–ì–ª–∏–Ω–∞'
        };

        // Function to translate commodity name to Russian
        function translateCommodity(commodity) {
            if (!commodity) return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            return commodityTranslations[commodity] || commodity;
        }

        // Color mapping for different commodities
        const commodityColors = {
            'Gold': Cesium.Color.GOLD,
            'Silver': Cesium.Color.SILVER,
            'Copper': Cesium.Color.CHOCOLATE,
            'Iron': Cesium.Color.DARKRED,
            'Uranium': Cesium.Color.LIME,
            'Coal': Cesium.Color.BLACK,
            'Chromium': Cesium.Color.DARKGRAY,
            'Tungsten': Cesium.Color.GRAY,
            'Manganese': Cesium.Color.PURPLE,
            'Mercury': Cesium.Color.LIGHTGRAY,
            'Tin': Cesium.Color.LIGHTSTEELBLUE,
            'Lead': Cesium.Color.DARKSLATEGRAY
        };

        // Function to get color for commodity
        function getColorForCommodity(commodity) {
            if (commodityColors[commodity]) {
                return commodityColors[commodity];
            }
            return Cesium.Color.CYAN;
        }

        // Load GeoJSON data
        async function loadData() {
            const loadingDiv = document.getElementById('loading');
            const loadBtn = document.getElementById('loadDataBtn');

            loadingDiv.classList.remove('hidden');
            loadBtn.disabled = true;

            try {
                const response = await fetch('data/mrds.geojson');

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('–§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–∞—á–∞–π—Ç–µ –∏ —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–≥–ª–∞—Å–Ω–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ data/README.md');
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const geojson = await response.json();

                if (!geojson.features || geojson.features.length === 0) {
                    throw new Error('–§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç');
                }

                allData = geojson;

                // Extract unique commodities
                geojson.features.forEach(feature => {
                    const commodity = feature.properties.commodity;
                    if (commodity) {
                        commodities.add(commodity);
                    }
                });

                // Populate commodity filter with Russian translations
                const select = document.getElementById('commodityFilter');
                const sortedCommodities = Array.from(commodities).sort();
                sortedCommodities.forEach(commodity => {
                    const option = document.createElement('option');
                    option.value = commodity;
                    // Show Russian translation with English name in parentheses
                    option.textContent = `${translateCommodity(commodity)} (${commodity})`;
                    select.appendChild(option);
                });

                // Display all data initially
                displayData(geojson);

                loadingDiv.classList.add('hidden');
                loadBtn.textContent = '–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã';

            } catch (error) {
                console.error('Error loading data:', error);
                loadingDiv.innerHTML = `
                    <div style="color: #FF6B6B; max-width: 400px;">
                        <h3 style="margin-bottom: 10px;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h3>
                        <p style="margin-bottom: 15px;">${error.message}</p>
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; text-align: left; font-size: 11px;">
                            <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö:</strong><br><br>
                            1. –°–∫–∞—á–∞–π—Ç–µ –¥–∞–Ω–Ω—ã–µ:<br>
                            <code style="background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 2px;">curl -L -o data/mrds-csv.zip https://mrdata.usgs.gov/mrds/mrds-csv.zip</code><br><br>
                            2. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –∞—Ä—Ö–∏–≤:<br>
                            <code style="background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 2px;">unzip data/mrds-csv.zip -d data/</code><br><br>
                            3. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ GeoJSON:<br>
                            <code style="background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 2px;">python3 data/convert_to_geojson.py</code><br><br>
                            –ü–æ–¥—Ä–æ–±–Ω–µ–µ: <a href="data/README.md" style="color: #4FC3F7;">data/README.md</a>
                        </div>
                    </div>
                `;
                loadBtn.disabled = false;
                loadBtn.textContent = '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É';
            }
        }

        // Helper function to show info box with feature data
        function showFeatureInfo(coords) {
            const commodity = coords.commodity || 'Unknown';

            // Create description with Russian translations
            const description = `
                <div style="font-family: 'Segoe UI', sans-serif; max-width: 300px;">
                    <h3 style="margin-bottom: 10px; color: #4FC3F7;">${coords.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h3>
                    <p style="margin: 5px 0;"><strong>–†–µ—Å—É—Ä—Å:</strong> ${translateCommodity(commodity)}</p>
                    ${coords.commodity2 ? `<p style="margin: 5px 0;"><strong>–î–æ–ø. —Ä–µ—Å—É—Ä—Å:</strong> ${translateCommodity(coords.commodity2)}</p>` : ''}
                    ${coords.commodity3 ? `<p style="margin: 5px 0;"><strong>–î–æ–ø. —Ä–µ—Å—É—Ä—Å:</strong> ${translateCommodity(coords.commodity3)}</p>` : ''}
                    <p style="margin: 5px 0;"><strong>–°—Ç—Ä–∞–Ω–∞:</strong> ${coords.country || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                    ${coords.state ? `<p style="margin: 5px 0;"><strong>–®—Ç–∞—Ç/–†–µ–≥–∏–æ–Ω:</strong> ${coords.state}</p>` : ''}
                    <p style="margin: 5px 0;"><strong>–°—Ç–∞—Ç—É—Å:</strong> ${coords.dev_status || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                    ${coords.url ? `<p style="margin: 5px 0;"><a href="${coords.url}" target="_blank" style="color: #4FC3F7;">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a></p>` : ''}
                </div>
            `;

            viewer.selectedEntity = undefined;
            viewer.infoBox.frame.innerHTML = description;
            viewer.infoBox.viewModel.showInfo = true;
        }

        // Setup global click handler (called once)
        function setupClickHandler() {
            if (clickHandler) {
                return;  // Already set up
            }

            clickHandler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
            clickHandler.setInputAction(function(click) {
                const pickedObject = viewer.scene.pick(click.position);

                if (!Cesium.defined(pickedObject)) {
                    return;
                }

                // Debug: Log picked object structure (remove in production)
                console.log('Picked object:', pickedObject);

                // Handle PointPrimitive clicks (used for large datasets >10,000)
                if (currentDataSource && currentDataSource.primitives && currentDataSource.featureData) {
                    // For PointPrimitiveCollection, the primitive is the PointPrimitive itself
                    // and it has an 'id' property we set when adding points
                    const primitive = pickedObject.primitive;

                    // Check if this is a PointPrimitive from our collection
                    if (primitive && primitive.id !== undefined) {
                        const featureIndex = primitive.id;
                        if (typeof featureIndex === 'number' && currentDataSource.featureData[featureIndex]) {
                            console.log('Clicked point index:', featureIndex);
                            showFeatureInfo(currentDataSource.featureData[featureIndex]);
                            return;
                        }
                    }

                    // Alternative: check pickedObject.id directly
                    if (pickedObject.id !== undefined) {
                        const featureIndex = pickedObject.id;
                        if (typeof featureIndex === 'number' && currentDataSource.featureData[featureIndex]) {
                            console.log('Clicked point index (via pickedObject.id):', featureIndex);
                            showFeatureInfo(currentDataSource.featureData[featureIndex]);
                            return;
                        }
                    }
                }

                // Handle Entity clicks (used for small datasets <10,000)
                if (Cesium.defined(pickedObject.id) && pickedObject.id instanceof Cesium.Entity) {
                    // Entity clicks are handled automatically by Cesium
                    return;
                }

            }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
        }

        // Display data on globe using efficient PointPrimitiveCollection
        function displayData(geojson) {
            // Remove previous data if exists
            if (currentDataSource) {
                if (currentDataSource.primitives) {
                    // Remove primitive collection
                    viewer.scene.primitives.remove(currentDataSource.primitives);
                } else {
                    // Remove data source
                    viewer.dataSources.remove(currentDataSource);
                }
                currentDataSource = null;
            }

            // Ensure click handler is set up
            setupClickHandler();

            let displayedCount = 0;

            // For large datasets (>10,000 points), use PointPrimitiveCollection (much more efficient)
            if (geojson.features.length > 10000) {
                console.log(`Loading ${geojson.features.length} points using efficient PointPrimitiveCollection`);

                // Create a point primitive collection (much more memory efficient for large datasets)
                const pointPrimitives = viewer.scene.primitives.add(new Cesium.PointPrimitiveCollection());

                // Store feature data for click handling
                const featureData = [];

                // Add points in batches to avoid blocking UI
                const batchSize = 10000;
                let currentBatch = 0;

                function addBatch() {
                    const start = currentBatch * batchSize;
                    const end = Math.min(start + batchSize, geojson.features.length);

                    for (let i = start; i < end; i++) {
                        const feature = geojson.features[i];
                        const coords = feature.properties;
                        const lon = feature.geometry.coordinates[0];
                        const lat = feature.geometry.coordinates[1];
                        const commodity = coords.commodity || 'Unknown';

                        pointPrimitives.add({
                            position: Cesium.Cartesian3.fromDegrees(lon, lat),
                            pixelSize: 6,
                            color: getColorForCommodity(commodity),
                            outlineColor: Cesium.Color.WHITE,
                            outlineWidth: 1,
                            id: i  // Store index for click handling
                        });

                        // Store feature data separately
                        featureData[i] = coords;
                        displayedCount++;
                    }

                    // Update progress
                    document.getElementById('pointCount').textContent = displayedCount.toLocaleString('ru-RU');

                    currentBatch++;
                    if (end < geojson.features.length) {
                        // Schedule next batch
                        setTimeout(addBatch, 0);
                    } else {
                        console.log(`Finished loading ${displayedCount} points`);
                        document.getElementById('loadDataBtn').textContent = '–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã';
                        document.getElementById('loading').classList.add('hidden');
                    }
                }

                // Start loading batches
                addBatch();

                // Store reference for cleanup and click handling
                currentDataSource = {
                    primitives: pointPrimitives,
                    featureData: featureData,
                    geojson: geojson
                };

            } else {
                // For smaller datasets (<10,000 points), use entity-based rendering with click info
                console.log(`Loading ${geojson.features.length} points using entity-based rendering`);

                currentDataSource = new Cesium.CustomDataSource('mrds');

                geojson.features.forEach(feature => {
                    const coords = feature.properties;
                    const lon = feature.geometry.coordinates[0];
                    const lat = feature.geometry.coordinates[1];
                    const commodity = coords.commodity || 'Unknown';

                    const entity = currentDataSource.entities.add({
                        position: Cesium.Cartesian3.fromDegrees(lon, lat),
                        point: {
                            pixelSize: 6,
                            color: getColorForCommodity(commodity),
                            outlineColor: Cesium.Color.WHITE,
                            outlineWidth: 1
                        },
                        description: `
                            <div style="font-family: 'Segoe UI', sans-serif; max-width: 300px;">
                                <h3 style="margin-bottom: 10px; color: #4FC3F7;">${coords.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</h3>
                                <p style="margin: 5px 0;"><strong>–†–µ—Å—É—Ä—Å:</strong> ${translateCommodity(commodity)}</p>
                                ${coords.commodity2 ? `<p style="margin: 5px 0;"><strong>–î–æ–ø. —Ä–µ—Å—É—Ä—Å:</strong> ${translateCommodity(coords.commodity2)}</p>` : ''}
                                ${coords.commodity3 ? `<p style="margin: 5px 0;"><strong>–î–æ–ø. —Ä–µ—Å—É—Ä—Å:</strong> ${translateCommodity(coords.commodity3)}</p>` : ''}
                                <p style="margin: 5px 0;"><strong>–°—Ç—Ä–∞–Ω–∞:</strong> ${coords.country || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                                ${coords.state ? `<p style="margin: 5px 0;"><strong>–®—Ç–∞—Ç/–†–µ–≥–∏–æ–Ω:</strong> ${coords.state}</p>` : ''}
                                <p style="margin: 5px 0;"><strong>–°—Ç–∞—Ç—É—Å:</strong> ${coords.dev_status || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                                ${coords.url ? `<p style="margin: 5px 0;"><a href="${coords.url}" target="_blank" style="color: #4FC3F7;">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a></p>` : ''}
                            </div>
                        `
                    });

                    displayedCount++;
                });

                viewer.dataSources.add(currentDataSource);

                // Update stats
                document.getElementById('pointCount').textContent = displayedCount.toLocaleString('ru-RU');
            }
        }

        // Filter data by commodity
        document.getElementById('commodityFilter').addEventListener('change', function(e) {
            const selectedCommodity = e.target.value;

            if (!allData) return;

            // Show loading indicator
            const loadingDiv = document.getElementById('loading');
            loadingDiv.classList.remove('hidden');

            // Use setTimeout to allow UI to update before filtering starts
            setTimeout(function() {
                let dataToDisplay;
                if (selectedCommodity === '') {
                    dataToDisplay = allData;
                } else {
                    dataToDisplay = {
                        type: 'FeatureCollection',
                        features: allData.features.filter(f =>
                            f.properties.commodity === selectedCommodity ||
                            f.properties.commodity2 === selectedCommodity ||
                            f.properties.commodity3 === selectedCommodity
                        )
                    };
                }

                displayData(dataToDisplay);

                // Hide loading for small datasets (large datasets hide it in displayData batch processing)
                // IMPORTANT: Check the FILTERED dataset size, not the original allData size
                if (dataToDisplay.features.length <= 10000) {
                    loadingDiv.classList.add('hidden');
                }
            }, 100);
        });

        // Load data button
        document.getElementById('loadDataBtn').addEventListener('click', loadData);

        // Auto-load data on page load (optional - remove if you want manual loading)
        window.addEventListener('load', () => {
            // Uncomment to auto-load:
            // loadData();
        });
        } // End of initializeCesium function

        // Initialize Cesium when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeCesium);
        } else {
            // DOM is already loaded, initialize immediately
            initializeCesium();
        }
    </script>
</body>
</html>
